#!/usr/bin/env node

/**
 * Renkei System - ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
 * tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã€outputãƒšã‚¤ãƒ³ã«çµæœã‚’è¡¨ç¤º
 */

const path = require('path');
const { execSync } = require('child_process');

// ç°¡æ˜“çš„ãªè‰²ä»˜ã‘
const chalk = {
  blue: (text) => `\x1b[34m${text}\x1b[0m`,
  green: (text) => `\x1b[32m${text}\x1b[0m`,
  yellow: (text) => `\x1b[33m${text}\x1b[0m`,
  red: (text) => `\x1b[31m${text}\x1b[0m`,
  gray: (text) => `\x1b[90m${text}\x1b[0m`,
  cyan: (text) => `\x1b[36m${text}\x1b[0m`
};

// Bold versions
chalk.blue.bold = (text) => `\x1b[1m\x1b[34m${text}\x1b[0m`;
chalk.green.bold = (text) => `\x1b[1m\x1b[32m${text}\x1b[0m`;
chalk.red.bold = (text) => `\x1b[1m\x1b[31m${text}\x1b[0m`;

// ã‚¿ã‚¹ã‚¯èª¬æ˜ã‚’å–å¾—
function getTaskDescription() {
  const args = process.argv.slice(2);
  if (args.length === 0) {
    console.error(chalk.red('âŒ ã‚¿ã‚¹ã‚¯ã®èª¬æ˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„'));
    console.log('ä½¿ç”¨æ–¹æ³•: scripts/renkei-execute "ã‚¿ã‚¹ã‚¯ã®èª¬æ˜"');
    process.exit(1);
  }
  return args.join(' ');
}

// outputãƒšã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢
function clearOutputPane() {
  try {
    // outputãƒšã‚¤ãƒ³ã®IDã‚’å–å¾—
    const panes = execSync('tmux list-panes -t renkei -F "#{pane_id}:#{pane_title}"', { encoding: 'utf8' });
    const outputPaneId = panes.split('\n')
      .map(line => line.split(':'))
      .find(([_, title]) => title && title.includes('Output'))?.[0];
    
    if (outputPaneId) {
      // ãƒšã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢
      execSync(`tmux send-keys -t ${outputPaneId} C-l`);
    }
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆtmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆãªã©ï¼‰
  }
}

// outputãƒšã‚¤ãƒ³ã«å‡ºåŠ›
function sendToOutputPane(message) {
  try {
    // outputãƒšã‚¤ãƒ³ã®IDã‚’å–å¾—
    const panes = execSync('tmux list-panes -t renkei -F "#{pane_id}:#{pane_title}"', { encoding: 'utf8' });
    const outputPaneId = panes.split('\n')
      .map(line => line.split(':'))
      .find(([_, title]) => title && title.includes('Output'))?.[0];
    
    if (outputPaneId) {
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å„è¡Œã‚’é€ä¿¡
      const lines = message.split('\n');
      for (const line of lines) {
        if (line.trim()) {
          execSync(`tmux send-keys -t ${outputPaneId} "${line.replace(/"/g, '\\"')}" Enter`);
        } else {
          execSync(`tmux send-keys -t ${outputPaneId} Enter`);
        }
      }
    } else {
      console.log(message);
    }
  } catch (error) {
    // tmuxãŒä½¿ãˆãªã„å ´åˆã¯æ¨™æº–å‡ºåŠ›ã«
    console.log(message);
  }
}

// ãƒ¡ã‚¤ãƒ³å‡¦ç†
async function main() {
  const taskDescription = getTaskDescription();
  
  console.log(chalk.blue.bold('ğŸ¤– Renkei System - ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ'));
  console.log(chalk.gray(`ã‚¿ã‚¹ã‚¯: ${taskDescription}`));
  
  try {
    // tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç¢ºèª
    try {
      execSync('tmux has-session -t renkei', { stdio: 'pipe' });
    } catch {
      console.error(chalk.red('âŒ Renkeiã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“'));
      console.log(chalk.yellow('å…ˆã« ./scripts/renkei-start ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'));
      process.exit(1);
    }
    
    // outputãƒšã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢
    clearOutputPane();
    
    // outputãƒšã‚¤ãƒ³ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤º
    sendToOutputPane(`${chalk.cyan('â”'.repeat(60))}`);
    sendToOutputPane(`${chalk.cyan.bold('ğŸ¤– Renkei Task Execution')}`);
    sendToOutputPane(`${chalk.cyan('â”'.repeat(60))}`);
    sendToOutputPane(``);
    sendToOutputPane(`ğŸ“ ã‚¿ã‚¹ã‚¯: ${taskDescription}`);
    sendToOutputPane(`ğŸ• é–‹å§‹æ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}`);
    sendToOutputPane(``);
    sendToOutputPane(`${chalk.yellow('â³ ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ä¸­...')}`);
    sendToOutputPane(``);
    
    // Node.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å®Ÿè¡Œ
    const scriptPath = path.join(__dirname, 'renkei-worker.js');
    const result = execSync(`node "${scriptPath}" "${taskDescription}"`, {
      encoding: 'utf8',
      cwd: process.cwd(),
      env: { ...process.env, RENKEI_TMUX_OUTPUT: '1' }
    });
    
    // çµæœã‚’è¡¨ç¤º
    sendToOutputPane(``);
    sendToOutputPane(`${chalk.green('âœ… ã‚¿ã‚¹ã‚¯å®Œäº†')}`);
    sendToOutputPane(`ğŸ• çµ‚äº†æ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}`);
    sendToOutputPane(`${chalk.cyan('â”'.repeat(60))}`);
    
    console.log(chalk.green.bold('âœ… ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ'));
    
  } catch (error) {
    sendToOutputPane(``);
    sendToOutputPane(`${chalk.red('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')}`);
    sendToOutputPane(`${error.message}`);
    sendToOutputPane(`${chalk.cyan('â”'.repeat(60))}`);
    
    console.error(chalk.red.bold('âŒ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:'), error.message);
    process.exit(1);
  }
}

// å®Ÿè¡Œ
main();