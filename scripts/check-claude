#!/bin/bash

# Renkei System - Claude Command Checker
# Claude„Ç≥„Éû„É≥„Éâ„ÅåÂà©Áî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Çπ„ÇØ„É™„Éó„Éà

set -e

# „Ç´„É©„Éº„Ç≥„Éº„Éâ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

echo -e "${CYAN}${BOLD}üîç Claude Command Availability Check${NC}"
echo ""

# 1. claude„Ç≥„Éû„É≥„Éâ„ÅÆÂ≠òÂú®Á¢∫Ë™ç
echo -e "${BLUE}1. Checking if 'claude' command exists...${NC}"
if command -v claude &> /dev/null; then
    echo -e "${GREEN}‚úÖ 'claude' command found${NC}"
    CLAUDE_PATH=$(which claude)
    echo -e "   Path: ${CLAUDE_PATH}"
else
    echo -e "${RED}‚ùå 'claude' command not found${NC}"
    echo -e "${YELLOW}   Please install Claude CLI or add it to PATH${NC}"
    exit 1
fi

echo ""

# 2. „Éê„Éº„Ç∏„Éß„É≥Á¢∫Ë™ç
echo -e "${BLUE}2. Checking Claude version...${NC}"
if claude --version &> /dev/null; then
    VERSION=$(claude --version 2>&1)
    echo -e "${GREEN}‚úÖ Version check successful${NC}"
    echo -e "   Version: ${VERSION}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Version check failed${NC}"
    echo -e "   Error: $(claude --version 2>&1)"
fi

echo ""

# 3. ÂÆüË°åÊ®©Èôê„ÅÆÁ¢∫Ë™ç
echo -e "${BLUE}3. Checking execute permissions...${NC}"
if [ -x "$(command -v claude)" ]; then
    echo -e "${GREEN}‚úÖ Execute permission OK${NC}"
else
    echo -e "${RED}‚ùå No execute permission${NC}"
fi

echo ""

# 4. Á∞°Âçò„Å™Âãï‰Ωú„ÉÜ„Çπ„Éà
echo -e "${BLUE}4. Testing basic functionality...${NC}"
echo -e "${YELLOW}   Running: echo 'test' | claude --no-update-check 2>&1${NC}"

# „ÉÜ„Çπ„ÉàÂÆüË°å
TEST_OUTPUT=$(echo "test" | claude --no-update-check 2>&1 || true)
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Basic test passed${NC}"
    echo -e "   Exit code: 0"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Basic test returned non-zero exit code${NC}"
    echo -e "   Exit code: ${TEST_EXIT_CODE}"
fi

if [ -n "$TEST_OUTPUT" ]; then
    echo -e "   Output preview (first 3 lines):"
    echo "$TEST_OUTPUT" | head -3 | sed 's/^/     /'
fi

echo ""

# 5. Áí∞Â¢ÉÂ§âÊï∞„ÅÆÁ¢∫Ë™ç
echo -e "${BLUE}5. Checking relevant environment variables...${NC}"
if [ -n "$ANTHROPIC_API_KEY" ]; then
    echo -e "${GREEN}‚úÖ ANTHROPIC_API_KEY is set${NC}"
    echo -e "   Length: ${#ANTHROPIC_API_KEY} characters"
else
    echo -e "${YELLOW}‚ö†Ô∏è  ANTHROPIC_API_KEY is not set${NC}"
    echo -e "   This may be required for some Claude CLI features"
fi

echo ""

# 6. „Éó„É≠„Çª„ÇπËµ∑Âãï„ÉÜ„Çπ„Éà
echo -e "${BLUE}6. Testing process spawn capability...${NC}"
SPAWN_TEST=$(timeout 2s claude --help > /dev/null 2>&1 && echo "success" || echo "failed")

if [ "$SPAWN_TEST" = "success" ]; then
    echo -e "${GREEN}‚úÖ Process spawn test successful${NC}"
else
    echo -e "${RED}‚ùå Process spawn test failed${NC}"
    echo -e "   Claude process may be hanging or not responding"
fi

echo ""

# ÊúÄÁµÇÂà§ÂÆö
echo -e "${CYAN}${BOLD}üìä Summary${NC}"
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

if command -v claude &> /dev/null && [ $TEST_EXIT_CODE -eq 0 ] || [ $TEST_EXIT_CODE -eq 1 ]; then
    echo -e "${GREEN}${BOLD}‚úÖ Claude command is available and functional${NC}"
    echo -e "${GREEN}   Renkei System can use Claude for AI operations${NC}"
    exit 0
else
    echo -e "${RED}${BOLD}‚ùå Claude command is not properly configured${NC}"
    echo -e "${RED}   Renkei System will use mock mode for AI operations${NC}"
    echo ""
    echo -e "${YELLOW}Troubleshooting tips:${NC}"
    echo -e "1. Install Claude CLI: ${CYAN}pip install anthropic${NC}"
    echo -e "2. Check PATH: ${CYAN}export PATH=\$PATH:/path/to/claude${NC}"
    echo -e "3. Set API key: ${CYAN}export ANTHROPIC_API_KEY='your-api-key'${NC}"
    exit 1
fi