#!/usr/bin/env node

/**
 * Renkei System - Quick Kill Script
 * „Åô„Åπ„Å¶„ÅÆrenkeiÈñ¢ÈÄ£„Éó„É≠„Çª„Çπ„ÇíÂç≥Â∫ß„Å´ÂÅúÊ≠¢
 */

const { execSync } = require('child_process');

// „Ç´„É©„ÉºÂá∫Âäõ
const colors = {
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  reset: '\x1b[0m',
  bold: '\x1b[1m'
};

function log(message, color = '') {
  console.log(`${color}${message}${colors.reset}`);
}

log(`${colors.bold}üõë Killing all Renkei processes...${colors.reset}`, colors.red);

try {
  // tmux„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂº∑Âà∂ÁµÇ‰∫Ü
  try {
    execSync('tmux kill-session -t renkei-session 2>/dev/null', { stdio: 'pipe' });
    log('‚úÖ Killed tmux session: renkei-session', colors.green);
  } catch (e) {
    // „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
  }

  try {
    execSync('tmux kill-session -t renkei 2>/dev/null', { stdio: 'pipe' });
    log('‚úÖ Killed tmux session: renkei', colors.green);
  } catch (e) {
    // „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
  }

  // Node.js„Éó„É≠„Çª„Çπ„ÇíÂº∑Âà∂ÁµÇ‰∫Ü
  try {
    execSync('pkill -f "node.*dist/index" 2>/dev/null', { stdio: 'pipe' });
    log('‚úÖ Killed Node.js processes', colors.green);
  } catch (e) {
    // „Éó„É≠„Çª„Çπ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
  }

  // tail„Éó„É≠„Çª„Çπ„ÇíÂº∑Âà∂ÁµÇ‰∫Ü
  try {
    execSync('pkill -f "tail.*renkei-worker.log" 2>/dev/null', { stdio: 'pipe' });
    log('‚úÖ Killed tail processes', colors.green);
  } catch (e) {
    // „Éó„É≠„Çª„Çπ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
  }

  // ÊÆã„Å£„Å¶„ÅÑ„ÇãrenkeiÈñ¢ÈÄ£„Éó„É≠„Çª„Çπ„Çí„Åô„Åπ„Å¶ÁµÇ‰∫Ü
  try {
    execSync('pkill -f renkei 2>/dev/null', { stdio: 'pipe' });
  } catch (e) {
    // „Éó„É≠„Çª„Çπ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
  }

  // Á¢∫Ë™ç
  setTimeout(() => {
    try {
      const remaining = execSync('ps aux | grep -E "(renkei|node.*dist/index)" | grep -v grep | wc -l', { encoding: 'utf8' }).trim();
      
      if (parseInt(remaining) > 0) {
        log(`‚ö†Ô∏è  ${remaining} process(es) may still be running`, colors.yellow);
        log('Run "ps aux | grep renkei" to check', colors.yellow);
      } else {
        log('‚úÖ All Renkei processes have been killed', colors.green);
      }
    } catch (e) {
      log('‚úÖ All Renkei processes have been killed', colors.green);
    }
  }, 500);

} catch (error) {
  log(`‚ùå Error: ${error.message}`, colors.red);
  process.exit(1);
}